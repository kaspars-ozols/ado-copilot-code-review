# Copilot Instructions for ado-copilot-code-review

## Project Overview

Azure DevOps pipeline extension that automates PR code reviews using GitHub Copilot CLI. The extension fetches PR details via Azure DevOps REST API, invokes Copilot CLI for analysis, and posts inline comments back to the PR.

## Architecture

```
index.ts (orchestrator)
    ├── Installs GitHub Copilot CLI (winget on Windows, official script on Linux)
    ├── Calls PowerShell scripts via pwsh
    │   ├── Get-AzureDevOpsPR.ps1      → PR_Details.txt
    │   ├── Get-AzureDevOpsPRChanges.ps1 → Iteration_Details.txt
    │   └── Add-CopilotComment.ps1     → Posts comments via Add-AzureDevOpsPRComment.ps1
    └── Runs `copilot -p "$prompt"` with prompt.txt instructions
```

**Key Design Decision**: PowerShell scripts handle all Azure DevOps API interactions (auth, REST calls, comment posting). TypeScript orchestrates the workflow and manages Copilot CLI execution with timeouts.

## Build & Development

```powershell
# Build TypeScript (from repo root)
npm run build                     # Compiles CopilotCodeReviewV1/index.ts

# Build dev extension for testing
.\build-dev.ps1                   # Builds + copies to CopilotCodeReviewDevV1 + packages
.\build-dev.ps1 -SkipBuild        # Package only (uses existing compiled files)

# Package for marketplace
npm run package:prod              # Creates .vsix from vss-extension.json
npm run package:dev               # Creates dev .vsix from vss-extension.dev.json
```

**Version Sync**: Update version in THREE places: `package.json`, `CopilotCodeReviewV1/package.json`, `CopilotCodeReviewV1/task.json`, and `vss-extension.json`.

## Code Patterns

### Authentication Handling
Two auth modes in all Azure DevOps scripts:
- `Bearer` - OAuth via `System.AccessToken` (recommended for cloud)
- `Basic` - PAT with base64 encoding (required for on-prem)

```typescript
// index.ts sets env vars consumed by PowerShell scripts
process.env['AZUREDEVOPS_AUTH_TYPE'] = useSystemAccessToken ? 'Bearer' : 'Basic';
```

### PowerShell Script Pattern
All scripts follow this structure - maintain consistency:
```powershell
# Standard header with .SYNOPSIS, .PARAMETER docs
[CmdletBinding()]
param(...)

function Get-AuthorizationHeader { ... }   # Handles both auth types
function Invoke-AzureDevOpsApi { ... }     # Centralized REST calls with error handling
function Write-Output-Line { ... }          # Dual output to console + file
```

### Prompt Customization
- Default prompt: [scripts/prompt.txt](CopilotCodeReviewV1/scripts/prompt.txt)
- Custom prompt template: [scripts/prompt-custom.txt](CopilotCodeReviewV1/scripts/prompt-custom.txt) uses `%CUSTOMPROMPT%` placeholder
- **Constraint**: Custom prompts cannot contain double quotes (`"`) - validated in index.ts

### Comment Status Convention
```powershell
-Status 'Active'   # Feedback requiring changes
-Status 'Closed'   # Positive feedback or approval
```

### Azure DevOps REST API Patterns
All scripts use consistent API interaction patterns:
```powershell
# Base URL construction
$baseUrl = "https://dev.azure.com/$Organization/$Project/_apis"

# API versioning (always include)
$uri = "$baseUrl/git/repositories/$Repository/pullrequests/$Id?api-version=7.1"

# Error handling for common status codes
# 401 - Auth failed (invalid PAT or expired OAuth token)
# 404 - Resource not found (check org/project/repo/PR ID)
```

### Copilot CLI Flags
The task runs Copilot with specific permissions in [index.ts](CopilotCodeReviewV1/index.ts):
```bash
copilot -p "$prompt" --allow-all-paths --allow-all-tools --deny-tool 'shell(git push)'
```
- `--allow-all-paths` - Enables file access across the repo
- `--allow-all-tools` - Permits tool usage (shell commands, file ops)
- `--deny-tool 'shell(git push)'` - Safety: prevents accidental pushes during review

## Task Configuration

Inputs are defined in [task.json](CopilotCodeReviewV1/task.json). Key auto-detected values:
- `organization` - Extracted from `System.CollectionUri`
- `project` - Defaults to `$(System.TeamProject)`
- `pullRequestId` - Falls back to `$(System.PullRequest.PullRequestId)`

## Testing Locally

```powershell
# Set required environment variables
$env:INPUT_GITHUBPAT = "ghp_..."
$env:INPUT_USESYSTEMACCESSTOKEN = "false"
$env:INPUT_AZUREDEVOPSPAT = "ado-pat"
$env:INPUT_ORGANIZATION = "myorg"
$env:INPUT_PROJECT = "myproject"
$env:INPUT_REPOSITORY = "myrepo"
$env:INPUT_PULLREQUESTID = "123"

cd CopilotCodeReviewV1
node index.js
```

## Testing

**Current Gap**: The `CopilotCodeReviewV1/package.json` references `mocha tests/_suite.js` but no test files exist. Integration testing is currently manual via local execution or dev extension deployment.

## Publishing to Marketplace

1. **Bump version** in all 4 locations (see Version Sync above)
2. **Build and package**:
   ```powershell
   npm run build
   npm run package:prod    # Creates LittleFortSoftware.ado-copilot-code-review-X.X.X.vsix
   ```
3. **Upload** to [Azure DevOps Marketplace Publisher Portal](https://marketplace.visualstudio.com/manage/publishers)
4. **Dev testing**: Use `build-dev.ps1` to create a separate dev extension (`vss-extension.dev.json`) that can be installed alongside production

## File Modification Guidelines

- **index.ts**: Main orchestration logic. Changes here affect workflow sequence.
- **task.json**: Defines pipeline task inputs. Adding inputs requires corresponding handling in index.ts.
- **scripts/*.ps1**: Azure DevOps API interactions. Maintain consistent parameter patterns and error handling.
- **prompt.txt / prompt-custom.txt**: Review instructions for Copilot. The prompt instructs Copilot to use `Add-CopilotComment.ps1` for posting feedback.
